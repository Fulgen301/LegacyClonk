name: Build Binaries

on:
  workflow_call:
    inputs:
      matrix:
        type: string
        description: "Matrix to use for build"
        required: true

defaults:
  run:
    shell: bash

jobs:
  build-binaries:
    name: Build Binaries
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(inputs.matrix) }}
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: "Setup Directories"
        run: mkdir output

      - name: "Configure Platform"
        run: |
          echo "CONFIG_SUFFIX=${{ matrix.os }}-${{ matrix.arch }}" >> $GITHUB_ENV
          autobuild/${{ matrix.os }}.sh

      - name: "Configure Platform Architecture"
        run: |
          autobuild/${{ matrix.os }}-${{ matrix.arch }}.sh

      - name: "Linux: Setup"
        if: ${{ matrix.os == 'Linux' }}
        run: $CHROOT autobuild/setup_linux.sh

      - name: "Mac: Work around libpng mess"
        if: ${{ matrix.os == 'Mac' }}
        run: sudo rm -r /Library/Frameworks/Mono.framework/Headers

      - name: "Windows: Setup VS Dev Environment"
        if: ${{ matrix.os == 'Windows' }}
        uses: seanmiddleditch/gha-setup-vsdevenv@v4
        with:
          arch: ${{ env.VS_ARCH }}

      - name: "Dependencies"
        run: |
          mkdir deps
          cd deps
          curl -L https://github.com/legacyclonk/deps/releases/download/2024-07-24/lc_deps-$CONFIG_SUFFIX.tar.gz | tar -xz
          ./fix_paths.sh

      - name: Configure
        run: |
          $CHROOT cmake -B build . -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DUSE_TESTS=On -DCMAKE_CTEST_ARGUMENTS=--output-on-failure $CMAKE_CONFIGURE_ARGS

      - name: "Enable Debugrec"
        if: ${{ matrix.debugrec }}
        run: |
          cmake -B build -DDEBUGREC=On
          echo "CONFIG_SUFFIX=${{ matrix.os }}-${{ matrix.arch }}-debugrec" >> $GITHUB_ENV

      - name: "Disable PCH"
        if: ${{ matrix.debugrec && matrix.os == 'Linux' }}
        run: |
          cmake -B build -DUSE_PCH=Off

      - name: Build
        run: |
          $CHROOT cmake --build build $CMAKE_BUILD_ARGS

      - name: Test
        run: |
          $CHROOT cmake --build build --target test

      - name: "Windows: Collect binaries"
        if: ${{ matrix.os == 'Windows' }}
        run: |
          cd build
          mv *.{exe,pdb} ../output

      - name: "Linux: Collect binaries"
        if: ${{ matrix.os == 'Linux' }}
        run: |
          cd build
          cp clonk c4group ../output

      - name: "Linux: Create AppImage"
        if: ${{ matrix.os == 'Linux' }}
        run: |
          tools/make_AppImage.sh

      - name: "Mac: Create Bundle"
        if: ${{ matrix.os == 'Mac' }}
        run: |
          cd build
          DESTDIR=inst ninja install
          mv inst/usr/local/c4group inst/usr/local/clonk.app ../output

      - name: "Publish Engine"
        id: publish-engine
        uses: actions/upload-artifact@v4
        with:
          name: clonk-${{ env.CONFIG_SUFFIX }}
          path: output/clonk*

      - name: "Publish c4group"
        id: publish-c4group
        uses: actions/upload-artifact@v4
        with:
          name: c4group-${{ env.CONFIG_SUFFIX }}
          path: output/c4group*

      - name: "Build c4gs"
        if: ${{ matrix.include-groups }}
        run: |
          C4GROUP=output/c4group.exe tools/make_Graphics.c4g.sh
          C4GROUP=output/c4group.exe tools/make_System.c4g.sh

      - name: "Publish System.c4g"
        if: ${{ matrix.include-groups }}
        uses: actions/upload-artifact@v4
        with:
          name: System.c4g
          path: System.c4g

      - name: "Publish Graphics.c4g"
        if: ${{ matrix.include-groups }}
        uses: actions/upload-artifact@v4
        with:
          name: Graphics.c4g
          path: Graphics.c4g
